<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-12-11 Fri 13:17 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AJV Performance Benchmarking</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Thomas Baggaley" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://gongzhitaao.org/orgcss/org.css"/>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">AJV Performance Benchmarking</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgefce645">1. Issue</a></li>
<li><a href="#org833bf82">2. First culprit - AJV</a>
<ul>
<li><a href="#org42be90a">2.1. Performance analysis of AJV&rsquo;s <code>validate</code> call</a>
<ul>
<li><a href="#org799864e">2.1.1. Benchmarking of execution time as survey size increases</a></li>
<li><a href="#orgff422f9">2.1.2. Flame chart</a></li>
</ul>
</li>
<li><a href="#orgedf59f0">2.2. Optimising custom keywords</a>
<ul>
<li><a href="#org04b9f6c">2.2.1. Optimising validatePipingInTitle</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgde4620d">3. Second culprit - slow code in <code>src/validation/index.js</code></a>
<ul>
<li><a href="#org94cc231">3.1. Optimising the validation code</a></li>
</ul>
</li>
<li><a href="#org7a40c5f">4. Results</a>
<ul>
<li><a href="#org07fd734">4.1. Effect on response times</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgefce645" class="outline-2">
<h2 id="orgefce645"><span class="section-number-2">1</span> Issue</h2>
<div class="outline-text-2" id="text-1">
<p>
GraphQL responses take a long time for larger surveys. Loading the current draft of the Low Carbon Survey takes anywhere in the range of 500ms to over 1s for each response to resolve:
</p>


<div id="org7c502ef" class="figure">
<p><img src="./network_preopt.png" alt="network_preopt.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org833bf82" class="outline-2">
<h2 id="org833bf82"><span class="section-number-2">2</span> First culprit - AJV</h2>
<div class="outline-text-2" id="text-2">
<p>
Disabling AJV entirely results in response times resolving in approx. 100ms:
</p>


<div id="org752147c" class="figure">
<p><img src="./network_noajv.png" alt="network_noajv.png" />
</p>
</div>
</div>

<div id="outline-container-org42be90a" class="outline-3">
<h3 id="org42be90a"><span class="section-number-3">2.1</span> Performance analysis of AJV&rsquo;s <code>validate</code> call</h3>
<div class="outline-text-3" id="text-2-1">
</div>
<div id="outline-container-org799864e" class="outline-4">
<h4 id="org799864e"><span class="section-number-4">2.1.1</span> Benchmarking of execution time as survey size increases</h4>
<div class="outline-text-4" id="text-2-1-1">
<p>
To determine the contribution of AJV itself to the problem, the <code>validate</code> function call was called with a varying size questionnaire based on the Low Carbon Survey draft.
</p>

<p>
The final section of the survey was duplicated to take the questionnaire to 25 sections, then the benchmark was ran and sections deleted to obtain the following time-by-section-count graph:
</p>


<div id="orgb8f5c63" class="figure">
<p><img src="./Benchmark pre-optimisation.png" alt="Benchmark pre-optimisation.png" />
</p>
</div>

<p>
As can be seen, AJV itself - even with our custom keywords - is only responsible for approximately 50ms of the response&rsquo;s total execution time. The execution time of the <code>validate</code> call increases linearly with survey size.
</p>
</div>
</div>

<div id="outline-container-orgff422f9" class="outline-4">
<h4 id="orgff422f9"><span class="section-number-4">2.1.2</span> Flame chart</h4>
<div class="outline-text-4" id="text-2-1-2">
<p>
Below is a flame chart showing where CPU time is spent during the <code>validate(questionnaire)</code> call in <code>src/validation/index.js</code>:
</p>


<div id="orgb823962" class="figure">
<p><img src="./flame_chart.png" alt="flame_chart.png" />
</p>
</div>

<p>
This shows that the majority of CPU time is spent in the <code>cheerio</code> dependency, followed by the <code>getPreviousAnswersForPage</code> utility function.
</p>
</div>
</div>
</div>

<div id="outline-container-orgedf59f0" class="outline-3">
<h3 id="orgedf59f0"><span class="section-number-3">2.2</span> Optimising custom keywords</h3>
<div class="outline-text-3" id="text-2-2">
<p>
Disabling custom keywords entirely resulted in AJV <code>validate</code> times in the order of 1 - 2 ms for the 18 section draft LCS, showing that our custom keyword code was significantly slowing down execution.
</p>

<p>
Searching for <code>getPreviousAnswersForPage</code> in the custom keywords files showed that it was called by the <code>validatePipingInTitle</code> custom keyword. This file also happened to be the source of the calls to <code>cheerio</code>.
</p>
</div>

<div id="outline-container-org04b9f6c" class="outline-4">
<h4 id="org04b9f6c"><span class="section-number-4">2.2.1</span> Optimising validatePipingInTitle</h4>
<div class="outline-text-4" id="text-2-2-1">
<p>
<code>validatePipingInTitle</code> used the <code>cheerio</code> library to parse HTML in the question title - and as can be seen by the flame graph this was a very resource-intensive process. The HTML was parsed in order to find the included piped answer IDs - if any.
</p>

<div class="org-src-container">
<pre class="src src-javascript" id="orga934a4f">      <span style="color: #51afef;">const</span> <span style="color: #dcaeea;">$</span> = cheerio.load(entityData);
      <span style="color: #51afef;">const</span> <span style="color: #dcaeea;">pipedIdList</span> = [];

      $(<span style="color: #98be65;">"p"</span>)
        .find(<span style="color: #98be65;">"span"</span>)
        .each(<span style="color: #51afef;">function</span>(<span style="color: #dcaeea;">index</span>, <span style="color: #dcaeea;">element</span>) {
          pipedIdList.push($(element).data());
        });
</pre>
</div>

<p>
Replacing this approach with a regular expression maintained the original behaviour - piped answers are still detected to be deleted in titles - but avoided the need to use the <code>cheerio</code> library to parse HTML for every question in the questionnaire.
</p>

<div class="org-src-container">
<pre class="src src-javascript" id="orgde102ca">      <span style="color: #5B6268;">//</span><span style="color: #5B6268;">... in file scope</span>
      <span style="color: #51afef;">const</span> <span style="color: #dcaeea;">pipedAnswerIdRegex</span> = <span style="color: #98be65;">/data-piped="answers" data-id="(.+?)"/</span>gm;

      <span style="color: #5B6268;">//</span><span style="color: #5B6268;">... within custom validation function</span>
      <span style="color: #51afef;">const</span> <span style="color: #dcaeea;">pipedIdList</span> = [];

      <span style="color: #51afef;">let</span> <span style="color: #dcaeea;">matches</span>;
      <span style="color: #51afef;">do</span> {
        matches = pipedAnswerIdRegex.exec(entityData);
        <span style="color: #51afef;">if</span>(matches &amp;&amp; matches.length &gt; <span style="color: #da8548; font-weight: bold;">1</span>) {
          pipedIdList.push(matches[<span style="color: #da8548; font-weight: bold;">1</span>]);
        }
      } <span style="color: #51afef;">while</span> (matches);
</pre>
</div>

<p>
Making this change and re-running the benchmark showed that the execution time for the <code>validate</code> call (for the 18-section LCS survey) fell to <code>8.65ms</code>, a decrease of approximately 80%.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgde4620d" class="outline-2">
<h2 id="orgde4620d"><span class="section-number-2">3</span> Second culprit - slow code in <code>src/validation/index.js</code></h2>
<div class="outline-text-2" id="text-3">
<p>
With the above changes made and AJV performance improved, the following is a flame chart of the API server while running under load (repeatedly requesting questionnaire &amp; pages from the UI):
</p>


<div id="orgf273899" class="figure">
<p><img src="./flame_server_pre.png" alt="flame_server_pre.png" />
</p>
</div>

<p>
As seen here, our validation code in <code>src/validation/index.js</code> is responsible for a huge amount of the total CPU time spent on generating responses.
</p>

<p>
The key culprit seems to be the section involving calling the lodash <code>uniqWith</code> function.
</p>
</div>

<div id="outline-container-org94cc231" class="outline-3">
<h3 id="org94cc231"><span class="section-number-3">3.1</span> Optimising the validation code</h3>
<div class="outline-text-3" id="text-3-1">
<p>
<code>src/validation/index.js</code> calls AJV via <code>validate(questionnaire)</code> and then proceeeds to generate a list of error messages using <code>createValidationError</code>.
</p>

<p>
The part which was the performance bottleneck was that which checked for duplicated error messages, in order to remove them:
</p>

<div class="org-src-container">
<pre class="src src-javascript" id="org1d080dc">  <span style="color: #51afef;">const</span> <span style="color: #dcaeea;">uniqeErrorMessages</span> = uniqWith(formattedErrorMessages, (one, two) =&gt; {
    <span style="color: #51afef;">const</span> <span style="color: #dcaeea;">oneClone</span> = Object.assign({}, one);
    <span style="color: #51afef;">const</span> <span style="color: #dcaeea;">twoClone</span> = Object.assign({}, two);

    <span style="color: #51afef;">delete</span> oneClone.id;
    <span style="color: #51afef;">delete</span> twoClone.id;

    <span style="color: #51afef;">const</span> <span style="color: #dcaeea;">isDuplicate</span> = isEqual(oneClone, twoClone);

    <span style="color: #51afef;">return</span> isDuplicate;
  });
</pre>
</div>

<p>
The function already iterates over the entire array multiple times, but the crunch point for performance (especially looking at the V8 profiling logs) seems to be the repeated use of <code>Object.assign</code>, causing repeated memory allocation events.
</p>

<p>
This function was removed and checking for uniqueness implemented in the first iteration over the error messages using a javascript object as a hashmap. Error objects are stringified using the minimal information required by the downstream code (<code>dataPath</code> and <code>message</code>) to produce their hash.
</p>

<p>
Checking for duplicates in this way can therefore be done in constant time (using hashmap lookup). The entire function was also refactored to iterate only once over the array of errors rather than iterating several times throughout the process.
</p>

<p>
The new approach is as follows:
</p>

<div class="org-src-container">
<pre class="src src-javascript" id="org434fa38">  <span style="color: #51afef;">const</span> <span style="color: #dcaeea;">uniqueErrorMessages</span> = {};
  <span style="color: #51afef;">const</span> <span style="color: #dcaeea;">formattedErrorMessages</span> = [];

  <span style="color: #51afef;">for</span> (<span style="color: #51afef;">const</span> <span style="color: #dcaeea;">err</span> of validate.errors) {
    <span style="color: #51afef;">if</span> (err.keyword === <span style="color: #98be65;">"errorMessage"</span>) {
      <span style="color: #51afef;">const</span> <span style="color: #dcaeea;">key</span> = <span style="color: #98be65;">`${err.dataPath} ${err.message}`</span>;

      <span style="color: #51afef;">if</span> (uniqueErrorMessages[key]) {
        <span style="color: #51afef;">continue</span>;
      }
      uniqueErrorMessages[key] = err;

      formattedErrorMessages.push(formatErrorMessage(err, questionnaire));
    }
  }
</pre>
</div>
</div>
</div>
</div>



<div id="outline-container-org7a40c5f" class="outline-2">
<h2 id="org7a40c5f"><span class="section-number-2">4</span> Results</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org07fd734" class="outline-3">
<h3 id="org07fd734"><span class="section-number-3">4.1</span> Effect on response times</h3>
<div class="outline-text-3" id="text-4-1">
<p>
With these two changes, the overall response times are down to a level similar to that expected with validation disabled in the server code:
</p>


<div id="orgbb36f55" class="figure">
<p><img src="./network_postopt3.png" alt="network_postopt3.png" />
</p>
</div>

<p>
This represents a reduction in total response times of up to 80-90% compared to the pre-optimised codebase.
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Thomas Baggaley</p>
<p class="date">Created: 2020-12-11 Fri 13:17</p>
</div>
</body>
</html>
